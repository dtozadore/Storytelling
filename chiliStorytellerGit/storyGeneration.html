<!--is the user wants to generate a story-->
<!--change the question button management when there's action-->
<head>
    <meta charset="utf-8">
	<meta http-equiv="Cache-control" content="public">

	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<title>Apha-Mini Storytime!</title>
	<!-- Style taken from https://raw.githubusercontent.com/hypertexthero/htmlformtofile/master/index.html-->
	<style type="text/css" media="screen">
		body {font-family:verdana, sans-serif;  font-weight: 700; color:#271d1d; background:#f5b0b0; padding:20px; text-align:center;}
		h1 {font-size:50px; font-weight: bold; text-align:center; color: #920be1;}
		label {font-size:20px;font-weight: bold;}
		button {margin-left:205px; padding:5px; margin-top:5px; font-size:16px;}
		textarea {width:400px; font-size:16px; font-family: courier, "courier new", monospace; margin:0 0 5px 0; padding:5px; border:1px solid #eee; }
		select {margin:0 0 5px 0;}
		::placeholder {color:#d4d2d2;}
		.disabled{
			cursor: not-allowed;
			pointer-events: none;
		}
		.color-update{
			background-color: #007bff;
		}
		.slider{
			width: 400px;
			height: 30px;
			background: #d3d3d3;
			outline: none;
			opacity: 0.7;
			-webkit-transition: .2s;
			transition: opacity .2s;
		}

		.container{
			display: flex;
			justify-content: space-around;
			margin-bottom: 10px;
			text-align: center;

		}

		textarea{
			width: 75%;
			height: 100px;
			margin-top: 10px; 
			background-color: #fec9d4;
			overflow-y: hidden; 
			border-radius: 20px;
					
		}

		#storyPrompt {
			background-color: #F2F2F2;
		}
		#editableText{
			background-color:#fff9c4;
			display: none;
		}

		.button-container {
			text-align: center;
			margin-top: 10px;
		}
		button{
			margin: 5px;
			padding: 5px  10px;
			font-family: Arial, Helvetica, sans-serif;
			font-weight: 900;
			padding: 15px;
			letter-spacing: 1px;
			font-size: 20px;
			background-color: #bb94ff;
			border: 5px solid rgb(248, 149,s 19);
			border-radius: 20px; /*to have rounder buttons*/
			cursor: pointer; /*cursor to hand pointer*/			
		}
		button:hover{
			background-color: #5b03bf;
		}
		#submit-button:hover{
			background-color: #ffb74d;
		}	
		
		#mainButtons-container{
			text-align: center;
			padding: 20px;
		}
		#main-button{
			font-family: Arial, Helvetica, sans-serif;
			font-weight: 900;
			padding: 50px;
			letter-spacing: 1px;
			font-size: 40px;
			background-color: rgb(244, 159, 231);
			border: 5px solid blueviolet;
			cursor: pointer; /*cursor to hand pointer*/
		}
		#main-button:hover{
			background-color: blueviolet;
		}
		#submit-button{
			font-family: Arial, Helvetica, sans-serif;
			font-weight: 900;
			padding: 15px;
			letter-spacing: 1px;
			font-size: 20px;
			background-color: rgb(255, 220, 78);
			border: 5px solid rgb(248, 149,19);
			cursor: pointer; /*cursor to hand pointer*/		
			border-radius: 20px;	
		}
		#submit-button:hover{
			background-color: rgb(248, 149, 19);
		}

		.container2 {
			max-width: 600px;
			margin: 0 auto;
			padding: 20px;
			}

		.button2 {
			padding: 10px 20px;
			border: none;
			background-color: #6daeff;
			color: #fcfcfc;
			border-radius: 5px;
			cursor: pointer;
			margin-top: 10px;
		}

		.button2:hover {
			background-color: #1d34aa;
		}

		.button-group2 {
			display: flex;
			justify-content: space-between;
		}

		.header2 {
			font-size: 20px;
			font-weight: bold;
			margin-bottom: 20px;
		}

		.checkbox-label, .radio-label {
			display:list-item;
			margin-bottom: 10px;
			padding: 5px;
			background-color: #b6ebdf;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.checkbox-label:hover, .radio-label:hover {
			background-color: #12a1c4;
		}

		.radio-input:checked + .radio-label {
			background-color: #12a1c4;
			border-color: #12a1c4;
			color: white;
		}

		.checkbox-label.active, .radio-label.active {
			background-color: #12a1c4;
			border-color: #12a1c4;
			color: white;
		}

		.checkbox-label, .radio-label2 {
			display:list-item;
			margin-bottom: 10px;
			padding: 5px;
			background-color: #7e68fe;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.checkbox-label:hover, .radio-label2:hover {
			background-color: #2307dc;
		}

		.radio-input:checked + .radio-label2 {
			background-color: #2307dc;
			border-color: #2307dc;
			color: white;
		}

		.checkbox-label.active, .radio-label2.active {
			background-color: #2307dc;
			border-color: #2307dc;
			color: white;
		}

		.checkbox-label, .radio-label3 {
			display:list-item;
			margin-bottom: 10px;
			padding: 5px;
			background-color: #90fb9f;
			border-radius: 5px;
			cursor: pointer;
			transition: background-color 0.3s ease;
		}

		.checkbox-label:hover, .radio-label3:hover {
			background-color: #169d18;
		}

		.radio-input:checked + .radio-label3 {
			background-color: #169d18;
			border-color: #169d18;
			color: white;
		}

		.checkbox-label.active, .radio-label3.active {
			background-color: #0f7c10;
			border-color: #0f7c10;
			color: white;
		}


		.container_form {
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
            max-width: 700px;
            width: 100%;
            margin: 20px auto;
            overflow: hidden;
        }
        h2 {
            color: #6a1b9a;
            text-align: center;
            font-size: 1.5em;
            margin-bottom: 30px;
        }
		#questions_to_ask {
			height: 175px;
			overflow: auto;
		}

		
    
	</style>
</head>
 
<body>
    <h1> &#x1F916; &#x1F916; Storytime with Alpha-Mini &#x1F916; &#x1F916;  !</h1>
	<br>

	<div class="container2">
	<div id="language_selector" >
		<label > &#x1F916; : What should be the language of your story ? </label><br>
	<br>

	<label class="radio-label3">
		<input type="radio" id="en" name="language" value="0">
    	<label for="en"> &#x1F5E3;: English ðŸ‡ºðŸ‡¸</label><br>
	</label>

	<label class="radio-label3">
    	<input type="radio" id="fr" name="language" value="1">
    	<label for="fr"> &#x1F5E3;:Francais ðŸ‡«ðŸ‡· </label><br>  
	</label>

	<label class="radio-label3">
    	<input type="radio" id="de" name="language" value="2">
    	<label for="de"> &#x1F5E3;:Deutsch ðŸ‡©ðŸ‡ª</label><br>
	</label>
	</div>

		<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendLanguageData(this)"/>
	</div>
	

	<div id="story_input" style="display:none">
	<form method="post" id="story-form">
		<!--Radio buttons for level of ai of the story-->
	<label >&#x1F916;: First Things First... How much should i help you with your story :</label><br>
	<br>
	<div class="container2">
	<label class="radio-label2">
		<input type="radio" id="ai0" name="ai" value="0" onclick="showSlider(this.value)">
    	<label for="ai0">&#x1F5E3;: Provide the completed story</label><br>
	</label>

	<label class="radio-label2">
    	<input type="radio" id="ai1" name="ai" value="1" onclick="showSlider(this.value)">
    	<label for="ai1">&#x1F5E3;: Provide explanation about the story that you want Alpha-Mini to generate .</label><br>  
	</label>

	<label class="radio-label2">
    	<input type="radio" id="ai2" name="ai" value="2" onclick="showSlider(this.value)">
    	<label for="ai2">&#x1F5E3;: Provide the story topic and let Alpha-Mini come up with a story .</label><br>
	</label>

	<label class="radio-label2">
		<input type="radio" id="ai3" name="ai" value="3" onclick="showSlider(this.value)">
    	<label for="ai3">&#x1F5E3;: Write the beginning of the story, and make Alpha-Mini complete the rest.</label><br>
	</label>

	<label class="radio-label2">
		<input type="radio" id="ai4" name="ai" value="4" onclick="showSlider(this.value)">
    	<label for="ai4">&#x1F5E3;: Ask questions and make Alpha-Mini generate story based on the answers of these questions  </label><br>
	</label>
	</div>

	<br>
		<!-- Story or prompt to be inputted-->
	<div id = "storyBoxContent" style = "display: none">
	<label for="story-form" >&#x1F916;:Ready for your next step ?<br>
		Based on the option you choose, please write your instructions or story below :
	</label><br>
		<textarea form="story-form" id="story" cols="40" rows="10" placeholder="&#x1F5E3;: Once upon a time..."></textarea>
		<br>	
	</div>
	<br>
		<div id="story_length_slider" style="display:none">
			<p>&#x1F916;: Story length: <span id="length"></span> words</p>
			<input type="range" min="50" max="600" value="400" class="slider" id="story_length"> 
		</div>
	<br>

		<div class="container2" id="ageSelector" style="display:none">
			<div class="header2">&#x1F916; Select Your Audience:</div>
			<label class="radio-label">
				<input type="radio" name="age" id="age1" value="Toddlers">
				<label for="age1">ðŸ‘¶1-3 years</label>
			</label>
			<label class="radio-label">
				<input type="radio" id="age2" name="age" value="Preschoolers">
				<label for ="age2">ðŸ§’ 3-5 years</label>
			</label>
			<label class="radio-label">
				<input type="radio" name="age" id="age3"value="Early Elementary">
				<label for="age3">ðŸ‘¦5-7 years</label>
			</label>
			<label class="radio-label">            
				<input type="radio" name="age" id="age4" value="Late Elementary">
				<label for="age4">ðŸ‘§7-9 years</label><br>
			</label>
			<label class="radio-label">
				<input type="radio" name="age" id="age5" value="Preteens">
				<label for="age5">ðŸ§‘9-12 years</label>
			</label>
			
		</div>

	</form>
	<br>
	
	<p>&#x1F916;: Moving Right Along; Are you ready to generate your first story with me ? Click to "Clear All" button to restart !</p>
	<button type="submit" id= "submit-button" onclick="sendStoryData(this)">&#x1F44D; Submit</button>
	<button id="submit-button" onclick = "clearAll(this)">Clear All</button>
	
	</div>

	<div id="storyClass" style="display: none;">
    <h1>&#x1F916;: Storytelling Session</h1>
	<div class="container">
		<textarea id="editableText" style="display:none;" readonly ></textarea>
		<textarea id="storyPrompt" readonly >Waiting for the story...</textarea>
	</div>
		
	<div id="storyButtons" class="button-container" style="display: none">	
		<button id="editButton">Edit </button>
		<button id="goBackButton" style="display: none;">Go back</button>
		<button id="saveEdited" style="display: none;">Save Edited Version</button>
		<button id="sendModifiedButton" style="display: none;">Send Modified Version</button>
		<button id="keepStoryButton">Keep Story</button>
		<button id = "regenerateButton">Regenate Story</button>	
		<button id = "suggestionButton" onclick="suggestionBoxOnn()">Submit Suggestions & Regenate Story</button>	
					
	</div>

	<div class="container" id="suggestionBox" style = "display: none;">
			<label > &#x1F916; : If you want to change any detail in the story, let us know and submit! </label><br>	
			<textarea id="suggestions" ></textarea><br>
			<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="submitSuggestions()"/><br>
	</div>
	</div>

	<div id="questionPart" style="display:none">
	<div id="question_selector" style = "display:block">
		<label > &#x1F916; :  Optionally, do you want to ask questions about this story to the audience? </label><br>
	<br>

		<input type="radio" id="yes" name="question" value="0">
    	<label for="yes"> &#x1F5E3;: Yes</label><br>
    	<input type="radio" id="no" name="question" value="1">
    	<label for="no"> &#x1F5E3;:No </label><br>  
    	
		<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendQuestionData(this)"/>
	</div>

	<div id="answer_input" style="display:none">
			<!--Radio buttons for level of ai of the query generation-->
		<label >&#x1F916;: How much help do you need while writing your questions:</label><br>
		<br>
			<input type="radio" id="ai_0" name="ai_answer" value="0" >
			<label for="ai_0">&#x1F5E3;: No help. I will write my own questions ! </label><br>
			<input type="radio" id="ai_1" name="ai_answer" value="1">
			<label for="ai_1">&#x1F5E3;: I prefer auto-generated questions .</label><br>  
	
			<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendAnswerData(this)"/>
	</div>

	<div id = "query_human" style="display:none">
		<!--Questions about the story to be inputted-->
		<label for="'story-form' "> &#x1F916; :  Please provide for Alpha-Mini to ask.  Do not change the format of the text area : </label><br>
		<br>
			<textarea id="questions_to_ask" cols="40" rows="8"  style="width: 100%; padding: 10px; font-size: 16px;">
Questions: 
1.
2.
3.
Answers: 
1.
2.
3.
			</textarea>

		<div class="button-container">
			<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendQuestionToAskData(this)"/>
		</div>	
	
	</div>
	
	<div id = "submitToSeeAnswers" style="display: none;">
		<label for= "'story-form' "> NOT IMPLEMENTED Do you also wanna see possible answers to your questions?</label><br>
		<br>
		<input type="radio" id="submit_ans0" name="submitHum" value="0" >
		<label for="ai_0">&#x1F5E3;: Yes </label><br>
		<input type="radio" id="submit_ans1" name="submitHum" value="1">
		<label for="ai_1">&#x1F5E3;: No </label><br>  
			<input type="button" id="submit-button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendToSeeAns()"/>
	</div>

	<div id = "query_human_answers" style = "display: none">
		<label for="'story-form' "> &#x1F916; :Here's your Alpha-Mini generated answers : </label><br>
		<br>

			<textarea form="story-form" id="answers_hum_query " cols="40" rows="5"  ></textarea>
	</div>

	<div id = "query_ai" style="display:none">
		<!--Questions about the story to be inputted by AI -->
		<label for="'story-form' "> &#x1F916; : Generated Questions with answers and citations from the story:<br> 
			Reminder: You may adjust the questions by utilizing the "Modify" button. Kindly provide your responses accordingly without altering the original format.<br>
		</label><br>
		<br>
			<textarea form="story-form" id="questions_ai" cols="40" rows="5" placeholder="Generating..." ></textarea>

			<div id="questionButtons" class="button-container" style="display: none">
				<button id="keepButton2">Keep All</button>
				<button id = "regenerateButton2">Regenate Questions</button>	
				<button id = "modifyButton2">Modify </button>	
			</div>
	</div>

	<div id = "buttonAfterModified" class="button-container" style="display:none">
		<button id = "submitButton2">Submit </button>	
	</div>

	<div id="select_question" style="display:none">
		<form>
			<p>Please select the question(s) you want to keep (you can choose more than one):</p>

			<input type="checkbox" id="1." name="1." value="1.">
			<label for="1.">Keep Question 1</label><br>

			<input type="checkbox" id="2." name="2." value="2.">
			<label for="2.">Keep Question 2</label><br>

			<input type="checkbox" id="3." name="3." value="3.">
			<label for="3.">Keep Question 3</label><br>

			<div class="button-container">
				<input type="button" value = "&#x1F44D; Submit" style="margin-bottom: 20px;" onclick="sendSelectedQuestions()"/>
			</div>

		</form>
	</div>	

	<div id = "sessionDiv" style = "display: none"> 
		<label> &#x1F916; : Here's your session summary! </label><br>
		<br>
		<textarea id="sessionSummary" readonly ></textarea><br>
		<br>
		<!--Button to registered web client input-->
		<button onclick="saveTextBoxes()">Save Session</button><br>
		<button onclick="goNextStep()"> >Next Step</button>
		<button onclick="stopServer()">Exit</button>
		<br>
		
		
	</div>

	
	
	
	
	</div>
</body>
 
<script>

	//function to update the height of the text area based on the server message size
	function updateHeight(textValue){
		textValue.style.height = 'auto'; // reset height to shrink grow as needed
		textValue.style.height = textValue.scrollHeight + 'px'; // set height to to the text value height
	}

	document.addEventListener('DOMContentLoaded', function () {
		const labels3 = document.querySelectorAll('.radio-label3');
		const labels2 = document.querySelectorAll('.radio-label2');
		const labels = document.querySelectorAll('.radio-label');

		function handleLabelClick(event) {
			// Remove the active class from all labels
			labels3.forEach(lbl => lbl.classList.remove('active'));
			labels2.forEach(lbl => lbl.classList.remove('active'));
			labels.forEach(lbl => lbl.classList.remove('active'));
			// Add the active class to the clicked label
			event.currentTarget.classList.add('active');
		}

		labels3.forEach(label => {
			label.addEventListener('click', handleLabelClick);
		});

		labels2.forEach(label => {
			label.addEventListener('click', handleLabelClick);
		});

		labels.forEach(label => {
			label.addEventListener('click', handleLabelClick);
		});
	});

	const stopServer = () => {
        const socket = new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
            socket.send("exit");
			closeWindow();
            socket.close()
        }); 
        window.location.href = 'survey.html'; // Redirect to the survey page
    }

	

	var slider = document.getElementById("story_length");
	var output = document.getElementById("length");
	output.innerHTML = slider.value;
	slider.oninput = function() {
		output.innerHTML = this.value;
	}
		
	var regenerateButton= document.getElementById("regenerateButton");
	var suggestionButton = document.getElementById("suggestionButton");
	var keepButton = document.getElementById("keepStoryButton");
	var editButton= document.getElementById("editButton");
	var storyPrompt = document.getElementById("storyPrompt");
	var goBackButton=  document.getElementById("goBackButton");
	var editableTextArea= document.getElementById("editableText");
	var submitButton2= document.getElementById("submitButton2");

	//button for query_human if they want auto generated answers for their questions
	var submitToSeeAnswersButton = document.getElementById("submitToSeeAnswers");

	// buttons for the AI generated questions
			
	var keepButton2 = document.getElementById("keepButton2");
	var regenerateButton2= document.getElementById("regenerateButton2");
	//var answer_citations = document.getElementById("answer_citations");
	var modifyButton2 = document.getElementById("modifyButton2");
	var question_ai_box = document.getElementById("questions_ai")
	var selectQuestions = document.getElementById("select_question");

	//Regen with suggestions button
	var suggestionBox = document.getElementById("suggestionBox");

	

	regenerateButton2.addEventListener('click',regenerateQuestions);

	function regenerateQuestions(){
		const socket = new WebSocket('ws://localhost:10000');
		socket.addEventListener('open', function(event){
			socket.send("Regenerate ");
			socket.close;
		});	
	}

	submitButton2.addEventListener('click', submitModifiedQuestions);

	//submitToSeeAnswersButton.addEventListener('click', submitToSeeAnswersFunction);

	//TODO
	function submitToSeeAnswersFunction(){
		socket.addEventListener('open', function (event) {
			var answer = document.querySelector('input[name="submitHum"]:checked').value;
			if(answer == 0){
				socket.send(answer);
				socket.close;
			}
			});
	}	

	function submitModifiedQuestions(){
		const socket = new WebSocket('ws://localhost:10000');
		socket.addEventListener('open', function(event){
			var modified_questions = question_ai_box.value;
			socket.send("Modified " + modified_questions);
			socket.close;
		});	
		submitButton2.disabled = true;
	}	

	// when the user wants to see ai generated answers to the questions
	const sendToSeeAns = () => {
		const socket = new WebSocket('ws://localhost:10000');
		socket.addEventListener('open', function(event){
			var answer = document.querySelector('input[name="submitHum"]:checked').value;
			if(answer==0){ 
				socket.send("Answers");
				socket.close;
				document.getElementById("query_human_answers").style.display= "block";
			}
		});
	}

	modifyButton2.addEventListener("click", function(){
		// make the area editable 
		if (question_ai_box.hasAttribute('readonly')){
			question_ai_box.removeAttribute('readonly');
		}
	})

	//next button is clicked, im directed to the robot interaction page
	function goNextStep(){
		if (globalCounter>0){
			console.log("getting directed  to the robot interaction phase");
			const socket =new WebSocket('ws://localhost:10000');
			socket.addEventListener('open', function (event) {
				socket.send("robot decision executed");  
				socket.close();	
			});
			window.location.href = 'robotInteraction.html'; // Redirect to the main page
		}
		else{
			// if the global counter less then 1, means im trying to exit without saving so im sending an alert to the user 
			alert("Warning: You are proceeding without saving the session");
			globalCounter+=1;
		}
	}
	
	// kept all the quesitons of AI 
	keepButton2.addEventListener("click", function(){
		const socket = new WebSocket('ws://localhost:10000');
		socket.addEventListener('open', function(event){
			socket.send("keepQuestions");

			document.getElementById("sessionDiv").style.display= "block";
			const date= "Date:" + new Date().toISOString();
			const storyValue = "Topic of choice: " + document.getElementById('story').value; 
			const storyPrompt ="Generated Story:" + document.getElementById('storyPrompt').value;
			const AIQ = "AI Generated Questions:" + "\n" + document.getElementById('questions_ai').value; 
			const session_information= date + "\n" + storyValue + "\n" + storyPrompt + "\n" + AIQ
			const areaUpdate =document.getElementById("sessionSummary")
			areaUpdate.value = session_information
			updateHeight(areaUpdate)

			localStorage.setItem('sharedTopic', document.getElementById('story').value);
			localStorage.setItem('sharedStory', document.getElementById('storyPrompt').value);
			localStorage.setItem('sharedQuestions', document.getElementById('questions_ai').value);

			string = document.getElementById('questions_ai').value;
			start   = string.lastIndexOf('?'); 
			end     = string.length;          
			var string_before_last_slash = string.substring(0, start+1);
			localStorage.setItem('sharedJustQuestions', string_before_last_slash);
			
			var string_after_last_slash = string.substring(start+1, end);
			localStorage.setItem('sharedJustAnswers', string_after_last_slash);

			localStorage.setItem('sharedText', areaUpdate.value);
			socket.close();
		});	
		this.disabled=true;	
		modifyButton2.disabled= true;
		regenerateButton2.disabled=true;		
	})

	// keep button pressed tracker
	let isPressed = false;

	var globalCounter = 0 // this is a counter for saveTextBox() and goNextStep() function

	//if i pressed on the keep story
	keepButton.addEventListener("click",function(){
		// when i press on keep button i disable any type of editing coming from regenerate with suggestions area 
		document.getElementById("suggestionBox").style.display="none";
		//when i press on keep button i also able the QandA phase of the model
		document.getElementById("questionPart").style.display="block";

		regenerateButton.style.display="none";
		editButton.style.display = "none";
		isPressed= !isPressed
		suggestionButton.style.display="none";
		

		var text_to_keep = storyPrompt.value;			
		var message = "keepStory" + " " + text_to_keep; 
		const socket = new WebSocket('ws://localhost:10000');
		socket.addEventListener('open', function(event){
			socket.send(message);
			socket.close();
		});		
		this.disabled=true;
		
	});
	
	

	// edit the story click received
	editButton.addEventListener("click",function(){
		// now editButton is pressed  so recognise that 
		if (storyPrompt.hasAttribute('readonly')){
			storyPrompt.removeAttribute('readonly');
			storyPrompt.focus();
		
		    this.style.display='none';// NEW
			editableTextArea.value= storyPrompt.value;
			editableTextArea.style.display="block";
			goBackButton.style.display= "block";
			document.getElementById('saveEdited').style.display="block";

			document.getElementById('editButton').style.display="none";
			document.getElementById('keepStoryButton').style.display="none";
			document.getElementById('regenerateButton').style.display="none";
			document.getElementById('suggestionButton').style.display="none";
			
			updateHeight(editableTextArea);
		} else {
			storyPrompt.setAttribute('readonly', 'true');
		
		}
	});

	goBackButton.addEventListener('click', function(){
		// now i already pressed to edit button on top of it i  press to go back what i wanna see is everything i had before 
		storyPrompt.value= editableTextArea.value;
		editableTextArea.style.display= "none";	
		storyPrompt.setAttribute('readonly', 'true');

		document.getElementById('editButton').style.display="block";
		document.getElementById('keepStoryButton').style.display="block";
		document.getElementById('regenerateButton').style.display="block";
		document.getElementById('suggestionButton').style.display="block";
		goBackButton.style.display= "none";
		document.getElementById('saveEdited').style.display="none";
	});

	document.getElementById('saveEdited').addEventListener('click', function(){
		editableTextArea.style.display= "none";	
		storyPrompt.setAttribute('readonly', 'true');

		document.getElementById('editButton').style.display="block";
		document.getElementById('keepStoryButton').style.display="block";
		document.getElementById('regenerateButton').style.display="block";
		document.getElementById('suggestionButton').style.display="block";
		goBackButton.style.display= "none";
		document.getElementById('saveEdited').style.display="none";

	});

	regenerateButton.addEventListener('click',regenerateStory);

	function regenerateStory(){
		const socket = new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
			var text_to_regenerate = storyPrompt.value;			
			var message = "regenerate" + " " + text_to_regenerate; 
			socket.send(message);	
            socket.close()
        });
    };	

	// make the suggestion box appear
	function suggestionBoxOnn(){
		suggestionBox.style.display= "block";
	}

	function saveStory(){
		const socket = new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
			// now save button is clicked so show to question part
			document.getElementById("questionPart").style.display= "block";
			var updateText = storyPrompt.value;			
			var message =  updateText; 

			editButton.disabled = true;
			editButton.classList.add('disabled');

			goBackButton.disabled = true;
			goBackButton.classList.add('disabled');

			regenerateButton.disabled = true;
			regenerateButton.classList.add('disabled');

			editableTextArea.style.display="none";

			suggestionButton.disabled=true; // new 
			suggestionButton.classList.add('disabled');

			keepButton.classList.add('disabled');

			socket.send(message);	
            socket.close()
        });
    };	

	function hideSlider(){
		document.getElementById("story_length_slider").style.display = "none";
	}
	function showSlider(aiLevel){
		document.getElementById("story_length_slider").style.display = "block";
		document.getElementById("ageSelector").style.display="block";
		document.getElementById("storyBoxContent").style.display = "block";
		console.log("AI level in showSlider()")
		console.log(aiLevel)
		// goal : change the placeholder value of the text area based on the ai level
		// step1: return the text area id  and store it 
		storyArea = document.getElementById("story");
		if(aiLevel=='0'){
			story.placeholder = "E.g : In a quiet village nestled between rolling hills, there lived a young girl named Nur. She loved exploring the nearby forest, where ancient trees whispered secrets of old. One day, while wandering deeper than ever before, she discovered a hidden glade bathed in golden sunlight. "
		}
		else if(aiLevel=='1'){
			storyArea.placeholder = "E.g : Story about a robot dog and its owner that goes to Barcelona to start their Europe adventures"
		}
		else if(aiLevel== '2'){
			storyArea.placeholder = "E.g : A time traveler's journey"
		}
		else if(aiLevel == '3'){
			storyArea.placeholder = "E.g : LONG YEARS AGO, there lived in a distant land we now call Tibet a handsome Prince named Sunlight. Sunlight lived in a splendid palace with his father, the ruler of the land, called a Khan. One day, Sunlight's mother ..."
		}
		else if(aiLevel == '4'){
			storyArea.placeholder = "E.g : What time was it when they got out of home ? Who was the special guest ?"
		}
		else {
			storyArea.placeholder = "E.g : Once upon a time..."
		 }
	}
	function clearAll(some){
		some.disabled=true;
		document.getElementById('story-form').reset();
		document.getElementById("length").innerHTML = 400;
		hideSlider();
	}

	var ws = new WebSocket("ws://localhost:10000/");
        
    ws.onmessage = function(event) {
		var message = event.data;		
		var firstWord = message.toLowerCase().trim();
		console.log(firstWord);
		
		if(firstWord.startsWith("questions:") || 
			firstWord.startsWith("questions :") || 
			firstWord.startsWith("fragen:") || 
			firstWord.startsWith("fragen :") ){
			const queryAI = document.getElementById('questions_ai');
			queryAI.value = message;
			updateHeight(queryAI);
			document.getElementById('questionButtons').style.display= "block";
		}else if(firstWord.startsWith("answers:")){
			const answered = document.getElementById('answers_hum_query');
			answered.value = message;
			updateHeight(answered);
			document.getElementById('query_human_answers').style.display="block";
		}else{
            // Assuming the message is the story or feedback to be displayed
			const storyPromptMain =document.getElementById('storyPrompt');
        	storyPromptMain.value = message;
			updateHeight(storyPromptMain);				
			document.getElementById('storyButtons').style.display= "block";

		}
        };

    ws.onopen = function(event) {console.log("Connection opened"); };

    ws.onerror = function(error) {csonsole.log('WebSocket Error: ' + error);};

    ws.onclose = function(event) {console.log("Connection closed"); };

	const sendLanguageData = (some) => {
		const deButton = document.getElementById('de');
		if(deButton.checked){
			localStorage.setItem('language', "de");
		}

		const frButton = document.getElementById('fr');
		if(frButton.checked){
			localStorage.setItem('language', "fr");
		}

		const enButton = document.getElementById('en');
		if(enButton.checked){
			localStorage.setItem('language', "en");
		}

		if(!deButton.checked && !frButton.checked && !enButton.checked){
			alert("Pick a language");
		}else{
			const socket = new WebSocket('ws://localhost:10000');
			socket.addEventListener('open', function (event) {
				some.style.display= "none";
				some.disabled=true;
				some.classList.add('disabled');
				const borderColor= getComputedStyle(some).borderColor;
				some.style.backgroundColor= borderColor;

				var language = document.querySelector('input[name="language"]:checked').value;
				document.getElementById("story_input").style.display = "block";
				socket.send(language);	
				socket.close()
			});
		}
    }

	const sendSelectedQuestions = () => {
		const socket = new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
			const checkboxes = document.querySelectorAll('input[type="checkbox"]:checked');
			var selectedOptions = [];
			checkboxes.forEach(checkbox=>{
				selectedOptions.push(checkbox.value);
			});
			socket.send("Selected "+ selectedOptions);	
			document.getElementById("sessionDiv").style.display= "block";
			const date= "Date:" + new Date().toISOString();
			const storyValue = "Topic of choice: " + document.getElementById('story').value; 
			const storyPrompt ="Generated Story:" + document.getElementById('storyPrompt').value;
			const AIQ = "AI Generated Questions:" + "\n" + document.getElementById('questions_ai').value; 
			const AIQ_selected = "You selected to keep following questions : " + selectedOptions
			const session_information= date + "\n" + storyValue + "\n" + storyPrompt + "\n" + AIQ + "\n" + AIQ_selected
			const areaUpdate =document.getElementById("sessionSummary");
			areaUpdate.value = session_information;
			updateHeight(areaUpdate);
			
			localStorage.setItem('sharedTopic', document.getElementById('story').value);
			localStorage.setItem('sharedStory', document.getElementById('storyPrompt').value);
			localStorage.setItem('sharedQuestions', document.getElementById('questions_ai').value + "\n" + AIQ_selected );

			string = document.getElementById('questions_ai').value + "\n" + AIQ_selected;
			start   = string.lastIndexOf('?'); 
			end     = string.length;          
			var string_before_last_slash = string.substring(0, start+1);
			localStorage.setItem('sharedJustQuestions', string_before_last_slash);
			
			var string_after_last_slash = string.substring(start+1, end);
			localStorage.setItem('sharedJustAnswers', string_after_last_slash);

			localStorage.setItem('sharedText', areaUpdate.value);

		});
	}

	// yes or no question event for should we generate questions for the story 
	const sendQuestionData = (some) => {
		const yesButton = document.getElementById('yes');
		const noButton = document.getElementById('no');
		if(!yesButton.checked && !noButton.checked){
			alert("Pick an answer");
		}else{
			some.disabled=true;
			some.classList.add('disabled');

			const borderColor= getComputedStyle(some).borderColor;
			some.style.backgroundColor= borderColor;

			const form = document.getElementById('question_selector');
			const radioButtons = form.querySelectorAll('input[type="radio"]');
			//Disable all buttons
			radioButtons.forEach(radio => {
				radio.disabled=true;
			});

			const socket =new WebSocket('ws://localhost:10000');
			socket.addEventListener('open', function (event) {
				var question = document.querySelector('input[name="question"]:checked').value;
					socket.send(question);  // sends 'yes' or 'no'
					if(question== '0'){
						// make the survey thing pop up 
						document.getElementById("answer_input").style.display = "block";
					}
					if(question=='1'){
						// output whats done so far somewhere under
						document.getElementById("sessionDiv").style.display= "block";

						// DATE of generation
						const date= "Date:" + new Date().toISOString();

						// TOPIC of generation
						const storyTopic =  document.getElementById('story').value;
						const storyValue = "Topic of choice: " + storyTopic; 
						localStorage.setItem('sharedTopic', storyTopic);

						// STORY of the generation
						const story = document.getElementById('storyPrompt').value;
						const storyPrompt ="Generated Story:" + story;
						localStorage.setItem('sharedStory', story);

						// RESUME of the generation
						const session_information= date + "\n" + storyValue + "\n" + storyPrompt;
						const areaUpdate =document.getElementById("sessionSummary");
						areaUpdate.value = session_information;
						updateHeight(areaUpdate);
						localStorage.setItem('sharedText', areaUpdate.value);
						
						localStorage.setItem('sharedQuestions', "\n");


					//	string = questionToAskData;

					}
					socket.close()		
				});
			}
		}

	// listen to suggestions to change the story 
	const submitSuggestions= () => {
		const socket =new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
			message = document.getElementById("suggestions").value;
			socket.send("suggestions :" + message);
			socket.close();
		});

	}

// Picking the levels of AI help 
	const sendAnswerData = (some) => {
		const ai0 = document.getElementById('ai_0');
		const ai1 = document.getElementById('ai_1');
		if(!ai0.checked && !ai1.checked){
			alert("Pick an answer");
		}else{
			some.disabled=true;
			some.classList.add('disabled');

			const borderColor= getComputedStyle(some).borderColor;
			some.style.backgroundColor= borderColor;

			const form = document.getElementById('answer_input');
			const radioButtons = form.querySelectorAll('input[type="radio"]');
			//Disable all buttons
			radioButtons.forEach(radio => {
				radio.disabled=true;
			});

			const socket =new WebSocket('ws://localhost:10000');
			socket.addEventListener('open', function (event) {
				var answer = document.querySelector('input[name="ai_answer"]:checked').value;
				if(answer== '0'){ // means i ask for no help im gonna write my questions 
					document.getElementById("query_human").style.display= "block";
				}
				else if(answer== '1'){
					document.getElementById("query_ai").style.display= "block";
					document.getElementById("questions_ai").setAttribute('readonly', 'true');		
				} 				
				socket.send("option" + answer + "is chosen");  // sends 'yes' or 'no'
				socket.close();	
			});
		}
	}	

	//function to find if there exist a button with a certain text
	function findButtonByText(text){
		const buttons = document.querySelectorAll('#submit-button');
		for(let button of buttons){
			if(button.textContent.trim()==text){
				return button;
			}
		}
		return null;
		}
	
   
	const sendStoryData = (some) => {
		console.log("sendStoryData function called");

		const age1 = !document.getElementById('age1').checked;
		const age2 = !document.getElementById('age2').checked;
		const age3 = !document.getElementById('age3').checked;
		const age4 = !document.getElementById('age4').checked;
		const age5 = !document.getElementById('age5').checked;
		const ageCheck = age1 && age2 && age3 && age4 && age5;

		const ai0 = !document.getElementById('ai0').checked;
		const ai1 = !document.getElementById('ai1').checked;
		const ai2 = !document.getElementById('ai2').checked;
		const ai3 = !document.getElementById('ai3').checked;
		const ai4 = !document.getElementById('ai4').checked;
		const aiCheck = ai0 && ai1 && ai2 && ai3 && ai4;

		const storyElement = document.getElementById("story");
		const storyValue = storyElement.value.trim();
		const storyCheck = storyValue === "";

		console.log("Age Check:", ageCheck);
		console.log("AI Check:", aiCheck);
		console.log("Story Check:", storyCheck);

		if (aiCheck || ageCheck || storyCheck) {
			alert("Warning! Fill in the whole form");
			console.log("Validation failed: missing required fields");
		} else {
			console.log("Validation passed: proceeding with submission");
			document.getElementById("storyClass").style.display = "block";

			const socket = new WebSocket('ws://localhost:10000');
			socket.addEventListener('open', function (event) {
				some.disabled = true;
				some.classList.add('disabled');

				const borderColor = getComputedStyle(some).borderColor;
				some.style.backgroundColor = borderColor;

				const clearText = "Clear All";
				const foundClearButton = findButtonByText(clearText);
				if (foundClearButton) {
					console.log('found the requested button');
					foundClearButton.classList.add('disabled');
				} else {
					console.log('button not found');
				}

				const ai = document.querySelector('input[name="ai"]:checked').value;
				console.log("Selected AI Level:", ai);

				storyElement.readOnly = true;

				const length = document.getElementById("length").innerHTML;
				const selectedAge = document.querySelector('input[name="age"]:checked').value;

				const form = document.getElementById('story-form');
				const radioButtons = form.querySelectorAll('input[type="radio"]');
				radioButtons.forEach(radio => {
					radio.disabled = true;
				});

				const message = ai + "|" + storyValue + "|" + length + "|" + selectedAge;
				console.log("Sending message:", message);
				socket.send(message);
				socket.close();
			});
		}
	};

	const sendQuestionToAskData = (some) => {
		some.disabled=true;

		const socket =new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
		//TODO: MAYBE DISABLE CLICKING ON THE SUBMIT BUTTON
			questions_box = document.getElementById("questions_to_ask");
			questions_box.setAttribute('readonly', 'true');
			var questionToAskData = questions_box.value;
			//submitToSeeAnswersButton.style.display="block";
			socket.send(questionToAskData);

			document.getElementById("sessionDiv").style.display= "block";
			const date= "Date:" + new Date().toISOString();
			const storyValue = "Topic of Choice: " + document.getElementById('story').value; 
			const storyPrompt ="Generated Story:" + document.getElementById('storyPrompt').value;
			const humanQ= "User-Prepared Questions:" + "\n" +questionToAskData
			const session_information= date + "\n" + storyValue + "\n" + storyPrompt + "\n" + humanQ
			const areaUpdate =document.getElementById("sessionSummary")
			areaUpdate.value = session_information
			updateHeight(areaUpdate)

			localStorage.setItem('sharedTopic', document.getElementById('story').value);
			localStorage.setItem('sharedStory', document.getElementById('storyPrompt').value);
			localStorage.setItem('sharedQuestions', questionToAskData);

			string = questionToAskData;
			start   = string.lastIndexOf('?'); 
			end     = string.length;          
			var string_before_last_slash = string.substring(0, start+1);
			localStorage.setItem('sharedJustQuestions', string_before_last_slash);
			
			var string_after_last_slash = string.substring(start+1, end);
			localStorage.setItem('sharedJustAnswers', string_after_last_slash);

			localStorage.setItem('sharedText', areaUpdate.value);
			
			socket.close()
		});
	} 
	
    

	function closeWindow(){
		window.open('', '_parent','');
		window.close();
	}

	//function to save everything on the page
	function saveTextBoxes(){
		// save session button is clicked so increase the value of the counter 
		globalCounter+=1;
		console.log("save Entries function is called ");
		// text area values
		const storyValue = document.getElementById('story').value; 
		const storyPrompt = document.getElementById('storyPrompt').value;
		const humanQuery = document.getElementById('questions_to_ask').value;
		const aiQuery =  document.getElementById('questions_ai').value;
 
		//Load, or create new array
		const entries = JSON.parse(localStorage.getItem('sessionEntry')) || [];
		const date= new Date().toISOString();
		entries.push({date, storyValue, storyPrompt, humanQuery, aiQuery});
		localStorage.setItem('sessionEntry', JSON.stringify(entries));
		var dict = {
            goal : "Story Generation Model",
            when : date,
            storyContent : storyValue,
            generatedStory : storyPrompt,
            humanGenQuestion: humanQuery,
            AIGenQuestion: aiQuery
        }; 

        console.log(dict)

        const socket =new WebSocket('ws://localhost:10000');
        socket.addEventListener('open', function (event) {
			socket.send(JSON.stringify(dict));  
			socket.close();	
		});


       }
	// function to start generating storytime
	function showStory(button){
		const borderColor= getComputedStyle(button).borderColor;
		button.style.backgroundColor= borderColor;
		document.getElementById("language_selector").style.display = "block";

	}
	// function to show project description for the users 
	function showDescription(button){
		const guide = document.getElementById('userGuide');
		if(button.innerText==="User Guide"){
			guide.style.display='block';
			button.innerText= "Close";
		}else if(button.innerText==="Close"){
			guide.style.display='none';
			button.innerText = "User Guide";
		}

	}

	// function to see previously saved things
	function showHistory(button){
		console.log("show Entries function is called ");
		const entryArea = document.getElementById('savedHistory');
		const entryThings = JSON.parse(localStorage.getItem('sessionEntry')) || [];
		console.log("Entries retrieved:", entryThings);
		// sort entries by timestamp in decreasing order 
		entryThings.sort((current,next) => new Date(current.timestamp)- new Date(next.timestamp));

		const savedHistory = document.getElementById('savedHistory')

		// change the text of the button
		if(button.innerText === "Show History"){
			button.innerText = "Close";
			// generate entry block  for each entry
			entryArea.innerHTML = entryThings.map(prompt => `
			<div >
				<h4>Saved on: ${prompt.date}</h4>
				<p>Story Topic : ${prompt.storyValue || "Story topic is not specified"}</p>
				<p>Story : ${prompt.storyPrompt || "Story not generated"}</p>
				<p>Human Generated questions: ${prompt.humanQuery || "Questions are not generated"}</p>
				<p>Autogenerated questions: ${prompt.aiQuery || "Questions are not generated"}</p>
				<p>______________________________________________________________________________________________________________________________________________________</p>
			</div>
			`).join(' ');	
			savedHistory.style.display= 'block';	 
		}else if(button.innerText=== "Close"){
			//<div id="savedHistory"></div>	
			savedHistory.style.display= 'none';
			button.innerText ="Show History";
	
		}
		else{
			button.innerText ="Show History";
		}

	

	}
	

</script>
 
</html>